<html>
  <head>

    <base href="https://websim.ai/app/markdown-timer/" />
    <title>Markdown Timer Editor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css">
    <style>
        @import url("https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap");
  body {
    font-family: "Roboto Mono", monospace;
  }
.timer-card {
  position: absolute;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  background-color: rgba(0, 0, 0, 0.75);
  color: white;
  padding: 10px 20px;
  border-radius: 8px;
  font-size: 2rem;
  font-weight: bold;
  z-index: 1000;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  text-align: center;
}


  .fade-enter-active,
  .fade-leave-active {
    transition: opacity 0.5s;
  }
  .fade-enter-from,
  .fade-leave-to {
    opacity: 0;
  }

  .timer-overlay {
    position: fixed;
    inset: 0;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  .timer-overlay.minimized {
    width: 100px;
    height: 50px;
    bottom: 10px;
    left: 10px;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 1000;
  }

  .hamburger-menu {
    position: fixed;
    top: 20px;
    right: 20px;
    cursor: pointer;
    z-index: 1002;
    font-size: 1.5rem;
    color: white;
    background-color: rgba(0, 0, 0, 0.7);
    padding: 10px;
    border-radius: 8px;
    transition: background-color 0.3s;
  }
  .hamburger-menu:hover {
    background-color: rgba(0, 0, 0, 0.9);
  }
  .menu-content {
    position: fixed;
    top: 70px;
    right: 20px;
    background-color: rgba(0, 0, 0, 0.95);
    border-radius: 8px;
    padding: 15px;
    display: none;
    max-width: 400px;
    min-width: 320px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
    z-index: 1001;
  }
  .menu-content.active {
    display: block;
  }
  .menu-content::-webkit-scrollbar {
    width: 8px;
  }
  .menu-content::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
  }
  .menu-content::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 4px;
  }
  .menu-content::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.5);
  }
  .session-detail {
    display: none;
  }
  .session-detail.active {
    display: block;
  }
  .chart-container {
    width: 100%;
    height: 400px;
  }
    </style>    

    </head>

  <body
    class="bg-gray-900 text-white min-h-screen flex flex-col items-center justify-center"
  >
    <div id="app" class="container mx-auto px-4 py-8 relative">
	    
	      <!-- Timer Card -->
	<div v-if="isTimerActive" class="timer-card">
	  {{ formatTime(currentTimer.remainingTime) }}
	</div>


      <div class="hamburger-menu" @click="toggleMenu">
        <i class="fas fa-bars text-2xl"></i>
      </div>
      <div :class="{'menu-content': true, 'active': isMenuActive}">
        <h3 class="text-xl font-bold mb-4">Settings</h3>

        <!-- Tempo Settings -->
        <div class="mb-4 p-3 bg-gray-700 rounded-lg">
          <h4 class="text-lg font-bold mb-2">
            <i class="fas fa-tachometer-alt mr-2"></i>Schedule Tempo
          </h4>
          <p class="text-xs text-gray-400 mb-3">Adjust task durations for your pace</p>
          <div class="flex flex-col space-y-2">
            <label class="flex items-center cursor-pointer p-2 rounded hover:bg-gray-600 transition" :class="{'bg-green-600': selectedTempo === '0.8'}">
              <input
                type="radio"
                name="tempo"
                value="0.8"
                v-model="selectedTempo"
                @change="saveTempoSettings"
                class="mr-3"
              />
              <span>
                <i class="fas fa-running mr-1"></i>Fast (80% time)
              </span>
            </label>
            <label class="flex items-center cursor-pointer p-2 rounded hover:bg-gray-600 transition" :class="{'bg-green-600': selectedTempo === '1.0'}">
              <input
                type="radio"
                name="tempo"
                value="1.0"
                v-model="selectedTempo"
                @change="saveTempoSettings"
                class="mr-3"
              />
              <span>
                <i class="fas fa-walking mr-1"></i>Standard (100% time)
              </span>
            </label>
            <label class="flex items-center cursor-pointer p-2 rounded hover:bg-gray-600 transition" :class="{'bg-green-600': selectedTempo === '1.2'}">
              <input
                type="radio"
                name="tempo"
                value="1.2"
                v-model="selectedTempo"
                @change="saveTempoSettings"
                class="mr-3"
              />
              <span>
                <i class="fas fa-hiking mr-1"></i>Slow (120% time)
              </span>
            </label>
          </div>
        </div>

        <!-- Efficiency Graph -->
        <div class="mb-4 p-3 bg-gray-700 rounded-lg">
          <h4 class="text-lg font-bold mb-2">Session History</h4>
          <button
            @click="showEfficiencyGraph"
            class="w-full px-4 py-2 bg-purple-500 hover:bg-purple-600 rounded-full text-sm font-bold"
          >
            <i class="fas fa-chart-line mr-2"></i>View History (H)
          </button>
        </div>

        <!-- Keyboard Shortcuts -->
        <div class="mb-4 p-3 bg-gray-700 rounded-lg">
          <h4 class="text-lg font-bold mb-2">
            <i class="fas fa-keyboard mr-2"></i>Keyboard Shortcuts
          </h4>
          <div class="text-xs text-gray-300 space-y-1">
            <p><kbd class="bg-gray-600 px-2 py-1 rounded">Space</kbd> Start/Pause timer</p>
            <p><kbd class="bg-gray-600 px-2 py-1 rounded">→</kbd> Skip task</p>
            <p><kbd class="bg-gray-600 px-2 py-1 rounded">←</kbd> Previous task</p>
            <p><kbd class="bg-gray-600 px-2 py-1 rounded">H</kbd> View history</p>
            <p><kbd class="bg-gray-600 px-2 py-1 rounded">M</kbd> Toggle menu</p>
          </div>
        </div>

        <hr class="my-4 border-gray-600" />

        <h3 class="text-xl font-bold mb-4">Saved Sessions</h3>
        <div
          v-for="(session, index) in savedSessions"
          :key="index"
          class="mb-4"
        >
          <p
            class="cursor-pointer font-bold"
            @click="toggleSessionDetails(index)"
          >
            Session {{ index + 1 }}
            <i
              :class="sessionDetailsVisible[index] ? 'fas fa-chevron-up' : 'fas fa-chevron-down'"
            ></i>
          </p>
          <div
            :class="{'session-detail': true, 'active': sessionDetailsVisible[index]}"
          >
            <p class="text-xs"><strong>Start:</strong> {{ session.startTime }}</p>
            <p class="text-xs"><strong>End:</strong> {{ session.endTime }}</p>
            <p class="text-xs mb-2"><strong>Total Time:</strong> {{ formatTime(session.totalTime) }}</p>
            <div class="text-xs mb-2" style="max-height: 150px; overflow-y: auto;">
              <p class="font-bold mb-1">Tasks ({{ session.timers.length }}):</p>
              <div v-for="(timer, i) in session.timers" :key="i" class="mb-1 pl-2 border-l border-gray-600">
                <div><strong>{{ timer.label }}</strong></div>
                <div class="text-gray-400">
                  {{ timer.startTime }} → {{ timer.endTime }}
                  <span v-if="timer.skipTime !== null" class="text-yellow-400">(Skipped)</span>
                </div>
              </div>
            </div>
            <div class="flex space-x-2">
              <button
                @click="downloadSession(index)"
                class="mt-2 px-3 py-1 bg-blue-500 hover:bg-blue-600 rounded text-xs font-bold"
              >
                <i class="fas fa-download mr-1"></i>Download
              </button>
              <button
                @click="showGraph(index)"
                class="mt-2 px-3 py-1 bg-green-500 hover:bg-green-600 rounded text-xs font-bold"
              >
                <i class="fas fa-chart-bar mr-1"></i>Graph
              </button>
            </div>
          </div>
          <hr class="my-2 border-gray-600" />
        </div>
      </div>

      <div class="text-center p-4 bg-gray-800 rounded-lg mb-8">
        <h1 class="text-4xl font-bold">Markdown Timer Editor</h1>
        <div class="text-sm font-normal text-gray-400 mt-2">
          <i class="fas fa-tachometer-alt mr-1"></i>
          <span>{{ selectedTempo === '0.8' ? 'Fast' : selectedTempo === '1.2' ? 'Slow' : 'Standard' }} Tempo</span>
        </div>
      </div>

      <div class="flex flex-col items-center space-y-6">
        <textarea
          v-model="timerInput"
          @input="saveToLocalStorage"
          class="w-full h-64 p-4 bg-gray-800 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="Enter your timer markdown here..."
        ></textarea>

        <div class="w-full bg-gray-800 p-4 rounded-lg">
          <h2 class="text-2xl font-bold mb-4">Timer Overview</h2>
          <div
            v-for="(timer, index) in timers"
            :key="index"
            class="flex justify-between items-center mb-2"
          >
            <span>{{ timer.label }}</span>
            <span>{{ formatTime(timer.duration) }}</span>
          </div>
          <div class="mt-4">
            <strong>Total Task Time:</strong> {{ formatTime(totalTime) }}
          </div>
        </div>

        <div class="flex space-x-4">
          <button
            @click="startTimers"
            class="px-6 py-3 bg-green-500 hover:bg-green-600 rounded-full text-xl font-bold transition duration-300 ease-in-out transform hover:scale-105"
          >
            <i class="fas fa-play mr-2"></i> Start (Space)
          </button>

        </div>
      </div>

      <div
        v-if="isTimerActive"
        class="fixed inset-0 timer-overlay flex items-center justify-center"
        @click="toggleTimerDisplay"
      >
        <div class="bg-gray-800 p-8 rounded-xl shadow-lg text-center">
          <h2 class="text-3xl font-bold mb-4">{{ currentTimer.label }}</h2>
          <p class="text-9xl font-bold mb-6">
            {{ formatTime(currentTimer.remainingTime) }}
          </p>
          <p class="text-xl">{{ getNextTimerLabel() }}</p>
          <div class="mt-6 flex justify-center space-x-4">

            <button
              @click.stop="goBack"

              class="px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded-full text-lg font-bold transition duration-300 ease-in-out"
            >
              <i class="fas fa-backward mr-2"></i>Back (←)
            </button>
            <button
              @click.stop="pauseTimer"
              class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 rounded-full text-lg font-bold transition duration-300 ease-in-out"
            >
              <i class="fas fa-pause mr-2"></i>Pause (Space)
            </button>
            <button
              @click.stop="skipTimer"
              class="px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded-full text-lg font-bold transition duration-300 ease-in-out"
            >
              <i class="fas fa-forward mr-2"></i>Skip (→)
            </button>
            
            <!-- Break -->
             <br>

          <button
            @click="stopTimers"
            class="px-6 py-3 bg-red-500 hover:bg-red-600 rounded-full text-xl font-bold transition duration-300 ease-in-out transform hover:scale-105"
          >
            <i class="fas fa-stop mr-2"></i>Stop
          </button> 


          </div>
          <div
            v-if="currentTimer.skipTime !== null"
            class="mt-4 text-lg text-gray-400"
          >
            Skipped at: {{ formatTime(currentTimer.skipTime) }}
          </div>
        </div>
      </div>

      <div
        v-if="showScoreScreen"
        class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-75"
      >
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl text-center">
          <h2 class="text-3xl font-bold mb-6">Score Screen</h2>
          <div v-for="(timer, index) in timers" :key="index" class="mb-4">
            <p class="text-xl"><strong>{{ timer.label }}</strong></p>
            <p>Started at: {{ timer.startTime }}</p>
            <p>Finished at: {{ timer.endTime }}</p>
            <p v-if="timer.skipTime !== null">
              Skipped at: {{ formatTime(timer.skipTime) }}
            </p>
            <p v-if="timer.skipTime !== null">
              Time saved: {{ formatTime(timer.duration - timer.remainingTime) }}
            </p>
            <hr class="my-2 border-gray-600" />
          </div>
          <div class="mt-6">
            <p class="text-lg">
              <strong>Session started at:</strong> {{ sessionStartTime }}
            </p>
            <p class="text-lg">
              <strong>Session finished at:</strong> {{ sessionEndTime }}
            </p>
            <p class="text-lg">
              <strong>Total time:</strong> {{ formatTime(totalTime -
              totalRemainingTime) }}
            </p>
          </div>
          <button
            @click="hideScoreScreen"
            class="mt-6 px-6 py-3 bg-green-500 hover:bg-green-600 rounded-full text-xl font-bold transition duration-300 ease-in-out"
          >
            Okay
          </button>
        </div>
      </div>

      <!-- Modal for displaying the chart -->
      <div
        v-if="showChartModal"
        class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-75"
      >
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl text-center relative">
          <canvas id="sessionChart" class="chart-container"></canvas>
          <button
            @click="closeChart"
            class="absolute top-2 right-2 px-3 py-1 bg-red-500 hover:bg-red-600 rounded-full text-lg font-bold"
          >
            X
          </button>
        </div>
      </div>

      <!-- Efficiency Graph Modal -->
      <div
        v-if="showEfficiencyModal"
        class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-75"
        style="z-index: 2000;"
      >
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl text-center relative" style="max-width: 900px; width: 90%;">
          <h3 class="text-2xl font-bold mb-4">Session History</h3>
          <p class="text-sm text-gray-400 mb-4">Track your time spent across sessions</p>
          <canvas id="efficiencyChart" class="chart-container"></canvas>
          <button
            @click="closeEfficiencyGraph"
            class="absolute top-2 right-2 px-3 py-1 bg-red-500 hover:bg-red-600 rounded-full text-lg font-bold"
          >
            X
          </button>
        </div>
      </div>
    </div>

    <script>
      const { createApp, ref, computed, onMounted } = Vue;

      createApp({
        setup() {
          const timerInput = ref("");
          const timers = ref([]);
          const isTimerActive = ref(false);
          const currentTimerIndex = ref(0);
          const isPaused = ref(false);
          const intervalId = ref(null);
          const showScoreScreen = ref(false);
          const isMenuActive = ref(false);
          const sessionStartTime = ref(null);
          const sessionEndTime = ref(null);
          const savedSessions = ref([]);
          const sessionDetailsVisible = ref([]);
          const showChartModal = ref(false);
          const showEfficiencyModal = ref(false);
          const selectedTempo = ref("1.0");
          let chartInstance = null;
          let efficiencyChartInstance = null;

          onMounted(() => {
            if (localStorage.getItem("timerInput")) {
              timerInput.value = localStorage.getItem("timerInput");
              parseTimers();
            }

            if (localStorage.getItem("savedSessions")) {
              savedSessions.value = JSON.parse(
                localStorage.getItem("savedSessions"),
              );
              sessionDetailsVisible.value = savedSessions.value.map(
                () => false,
              );
            }

            if (localStorage.getItem("selectedTempo")) {
              selectedTempo.value = localStorage.getItem("selectedTempo");
            }
          });

          const currentTimer = computed(() => {
            return (
              timers.value[currentTimerIndex.value] || {
                label: "",
                remainingTime: 0,
                skipTime: null,
                startTime: null,
                endTime: null,
              }
            );
          });

          const totalTime = computed(() => {
            return timers.value.reduce(
              (total, timer) => total + timer.duration,
              0,
            );
          });

          const totalRemainingTime = computed(() => {
            return timers.value.reduce(
              (total, timer) => total + timer.remainingTime,
              0,
            );
          });

          function parseTimers() {
            if (!timerInput.value) {
              timers.value = [];
              return;
            }
            const lines = timerInput.value.split("\n");
            const tempoMultiplier = parseFloat(selectedTempo.value);
            timers.value = lines
              .map((line) => {
                const match = line.match(
                  /^(#*)\s*(\d+(?:\.\d+)?)\s*(sec|min):\s*(.+)$/i,
                );
                if (match) {
                  const [, hashes, duration, unit, label] = match;
                  let durationInSeconds =
                    unit.toLowerCase() === "min"
                      ? parseFloat(duration) * 60
                      : parseFloat(duration);

                  // Apply tempo multiplier
                  durationInSeconds = Math.round(durationInSeconds * tempoMultiplier);

                  return {
                    duration: durationInSeconds,
                    label: label.trim(),
                    remainingTime: durationInSeconds,
                    skipTime: null,
                    startTime: null,
                    endTime: null,
                  };
                }
                return null;
              })
              .filter((timer) => timer !== null);
          }

        let holdTimeout = null;

function startFromTimer(index) {
  if (timers.value.length === 0) return;
  isTimerActive.value = true;
  currentTimerIndex.value = index;
  isPaused.value = false;
  sessionStartTime.value = new Date().toISOString();
  runTimer();
}



function startHold() {
    holdTimeout = setTimeout(() => {
        stopTimers();
    }, 1000); // Hold for 1 seconds to stop
}

function stopHold() {
    clearTimeout(holdTimeout);
}
 
	 function startTimers() {
	    if (timers.value.length === 0) return;
	    isTimerActive.value = true;
	    currentTimerIndex.value = 0;
	    isPaused.value = false;
	    sessionStartTime.value = new Date().toISOString(); // Save the exact start time
	    runTimer();
	} 

          function runTimer() {
            if (currentTimerIndex.value >= timers.value.length) {
              stopTimers();
              return;
            }

            const timer = timers.value[currentTimerIndex.value];
            timer.startTime = new Date().toLocaleTimeString();

            intervalId.value = setInterval(() => {
              if (!isPaused.value) {
                timer.remainingTime--;
                if (timer.remainingTime <= 0) {
                  clearInterval(intervalId.value);
                  timer.endTime = new Date().toLocaleTimeString();
                  playSound(timer.label);
                  currentTimerIndex.value++;
                  runTimer();
                }
              }
            }, 1000);
          }

         function stopTimers() {
            isTimerActive.value = false;
            isPaused.value = false;
            clearInterval(intervalId.value);
            sessionEndTime.value = new Date().toLocaleTimeString();

            if (timers.value.length > 2) {
              saveSession();
            }

            showScoreScreen.value = true;
          } 
     function saveSession() {
	          const session = {
			          startTime: sessionStartTime.value,
			          endTime: sessionEndTime.value,
			          totalTime: totalTime.value - totalRemainingTime.value,
			          timers: timers.value.map((timer) => ({
					              label: timer.label,
					              startTime: timer.startTime,
					              endTime: timer.endTime,
					              skipTime: timer.skipTime,
					              originalDuration: timer.duration,
					              remainingTime: timer.remainingTime,
					          })),
			          markdownInput: timerInput.value, 
			      };

	          let savedSessionsData = JSON.parse(localStorage.getItem("savedSessions")) || [];
	          savedSessionsData.push(session);

	          localStorage.setItem("savedSessions", JSON.stringify(savedSessionsData));
	          savedSessions.value = savedSessionsData;
	          sessionDetailsVisible.value.push(false);

	          if (savedSessions.value.length > 4) {
			          savedSessions.value.shift(); // remove the oldest session to keep only the last 4
			          sessionDetailsVisible.value.shift();
			      }
      }

         
	          function toggleMenu() {
            isMenuActive.value = !isMenuActive.value;
          }

          function toggleSessionDetails(index) {
            sessionDetailsVisible.value[index] =
              !sessionDetailsVisible.value[index];
          }

	function downloadSession(index) {
	    const session = savedSessions.value[index];
	    const currentDate = new Date().toISOString().split('T')[0]; // Get current date in YYYY-MM-DD format
	    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(session, null, 2));
	    const downloadAnchorNode = document.createElement("a");
	    downloadAnchorNode.setAttribute("href", dataStr);
	    downloadAnchorNode.setAttribute("download", `session_${index + 1}_${currentDate}.json`); // Add the current date to the filename
	    document.body.appendChild(downloadAnchorNode); // Required for Firefox
	    downloadAnchorNode.click();
	    downloadAnchorNode.remove();
	}
          function showGraph(index) {
            const session = savedSessions.value[index];
            const labels = session.timers.map((timer) => timer.label);
            const data = session.timers.map((timer) =>
              timer.remainingTime
                ? timer.originalDuration - timer.remainingTime
                : timer.originalDuration,
            );
            const backgroundColors = session.timers.map((timer) =>
              timer.skipTime !== null
                ? "rgba(255, 99, 132, 0.2)"
                : "rgba(75, 192, 192, 0.2)",
            );
            const borderColors = session.timers.map((timer) =>
              timer.skipTime !== null
                ? "rgba(255, 99, 132, 1)"
                : "rgba(75, 192, 192, 1)",
            );

            if (chartInstance) {
              chartInstance.destroy();
            }

            const ctx = document
              .getElementById("sessionChart")
              .getContext("2d");
            chartInstance = new Chart(ctx, {
              type: "bar",
              data: {
                labels,
                datasets: [
                  {
                    label: "Time Spent (seconds)",
                    data,
                    backgroundColor: backgroundColors,
                    borderColor: borderColors,
                    borderWidth: 1,
                  },
                ],
              },
              options: {
                scales: {
                  y: {
                    beginAtZero: true,
                  },
                },
                plugins: {
                  legend: {
                    display: false,
                  },
                },
              },
            });

            showChartModal.value = true;
          }

          function closeChart() {
            showChartModal.value = false;
          }

         function pauseTimer() {
            isPaused.value = !isPaused.value;
          }

          function skipTimer() {
            const timer = timers.value[currentTimerIndex.value];
            timer.skipTime = timer.remainingTime;
            clearInterval(intervalId.value);
            timer.endTime = new Date().toLocaleTimeString();
            currentTimerIndex.value++;
            if (currentTimerIndex.value < timers.value.length) {
              runTimer();
            } else {
              stopTimers();
            }
          } 
	

		function toggleTimerDisplay(event) {
    if (event.target === event.currentTarget) {
        // Instead of toggling visibility, you can add a class to minimize it
        const overlay = event.currentTarget;
        overlay.classList.toggle("minimized");  // Create a CSS class 'minimized' that reduces the size and places it in a corner
    }
}

function isLastTimer() {
  return currentTimerIndex.value === timers.value.length - 1;
}



function goBack(){
  if (currentTimerIndex.value > 0){
    clearInterval(intervalId.value);

    currentTimerIndex.value--;
    const previousTimer = timers.value[currentTimerIndex.value];
    previousTimer.remainingTime = previousTimer.duration;
    previousTimer.endTime = null;
    previousTimer.skipTime = null;
    runTimer();
  }

}




	          function hideScoreScreen() {
            showScoreScreen.value = false;
          }

          function saveToLocalStorage() {
            localStorage.setItem("timerInput", timerInput.value);
          }

          function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes.toString().padStart(2, "0")}:${remainingSeconds.toString().padStart(2, "0")}`;
          }

          function getNextTimerLabel() {
            const nextTimer = timers.value[currentTimerIndex.value + 1];
            return nextTimer ? `Next: ${nextTimer.label}` : "Last timer";
          }

          function playSound(label) {
            const audio = new Audio(
              label.toLowerCase().includes("rest")
                ? "https://websim.ai/sounds/relax.mp3"
                : "https://websim.ai/sounds/bell.mp3",
            );
            audio.play();
          }

          function saveTempoSettings() {
            localStorage.setItem("selectedTempo", selectedTempo.value);
            parseTimers(); // Re-parse timers with new tempo
          }

          function showEfficiencyGraph() {
            if (savedSessions.value.length === 0) {
              alert("No sessions available for efficiency analysis");
              return;
            }

            // Prepare data - simpler approach using session.totalTime
            const sessionLabels = savedSessions.value.map((_, index) => `Session ${index + 1}`);
            const sessionTimes = savedSessions.value.map(session => session.totalTime);
            const taskCounts = savedSessions.value.map(session => session.timers.length);

            if (efficiencyChartInstance) {
              efficiencyChartInstance.destroy();
            }

            const ctx = document.getElementById("efficiencyChart").getContext("2d");
            efficiencyChartInstance = new Chart(ctx, {
              type: "line",
              data: {
                labels: sessionLabels,
                datasets: [
                  {
                    label: "Time Spent (seconds)",
                    data: sessionTimes,
                    backgroundColor: "rgba(75, 192, 192, 0.2)",
                    borderColor: "rgba(75, 192, 192, 1)",
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                  y: {
                    beginAtZero: true,
                    title: {
                      display: true,
                      text: 'Time (seconds)',
                      color: "white",
                    },
                    ticks: {
                      color: "white",
                      callback: function(value) {
                        const mins = Math.floor(value / 60);
                        const secs = value % 60;
                        return mins + ':' + secs.toString().padStart(2, '0');
                      }
                    },
                    grid: {
                      color: "rgba(255, 255, 255, 0.1)",
                    },
                  },
                  x: {
                    ticks: {
                      color: "white",
                    },
                    grid: {
                      color: "rgba(255, 255, 255, 0.1)",
                    },
                  },
                },
                plugins: {
                  legend: {
                    labels: {
                      color: "white",
                    },
                  },
                  tooltip: {
                    callbacks: {
                      label: function(context) {
                        const mins = Math.floor(context.parsed.y / 60);
                        const secs = context.parsed.y % 60;
                        const tasks = taskCounts[context.dataIndex];
                        return [
                          `Time: ${mins}:${secs.toString().padStart(2, '0')}`,
                          `Tasks: ${tasks}`
                        ];
                      }
                    },
                  },
                },
              },
            });

            showEfficiencyModal.value = true;
          }

          function closeEfficiencyGraph() {
            showEfficiencyModal.value = false;
          }

          // Setup keyboard shortcuts
          function handleGlobalKeyDown(e) {
            // Don't trigger shortcuts when typing in textarea
            if (document.activeElement.tagName === "TEXTAREA") {
              return;
            }

            // Global shortcuts
            if (e.key === "h" || e.key === "H") {
              e.preventDefault();
              showEfficiencyGraph();
              return;
            }
            if (e.key === "m" || e.key === "M") {
              e.preventDefault();
              toggleMenu();
              return;
            }

            // Timer-specific shortcuts
            if (isTimerActive.value) {
              if (e.key === " ") {
                e.preventDefault();
                pauseTimer();
                return;
              }
              if (e.key === "ArrowRight" && currentTimerIndex.value < timers.value.length - 1) {
                e.preventDefault();
                skipTimer();
                return;
              }
              if (e.key === "ArrowLeft" && currentTimerIndex.value > 0) {
                e.preventDefault();
                goBack();
                return;
              }
            }
          }

          // Register keyboard listener
          window.addEventListener("keydown", handleGlobalKeyDown);

          return {
            timerInput,
            timers,
            isTimerActive,
            currentTimer,
            totalTime,
            totalRemainingTime,
            parseTimers,
            startTimers,
            stopTimers,
            pauseTimer,
            skipTimer,
            toggleTimerDisplay,
            hideScoreScreen,
            saveToLocalStorage,
            formatTime,
            getNextTimerLabel,
            playSound,
            showScoreScreen,
            isMenuActive,
            toggleMenu,
            savedSessions,
            sessionDetailsVisible,
            toggleSessionDetails,
            downloadSession,
            showGraph,
            showChartModal,
            closeChart,
            sessionStartTime,
            sessionEndTime,
            goBack,
            selectedTempo,
            saveTempoSettings,
            showEfficiencyGraph,
            showEfficiencyModal,
            closeEfficiencyGraph,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>


